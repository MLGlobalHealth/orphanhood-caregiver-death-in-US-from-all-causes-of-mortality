---
html_document: default
title: "![](figures/logo_family_c.png){width=2in}"
css: style.css
theme: yeti
sansfont: Calibri Light
fontsize: 11pt
---

```{r setup, include = FALSE}
knitr::opts_knit$set(
  collapse = TRUE,
  comment = "#>",
  root.dir = '.'
)
analysis <- 'Q1_2023'
analysis_date <- '31st March 2022'
```

```{r, include=TRUE, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, tidy=TRUE}
require(knitr)
require(kableExtra)
require(ggplot2)
require(ggpubr)
require(gridExtra)
require(albersusa)
require(data.table)
require(tidyr)
require(dplyr)
require(tidyverse)
require(leaflet)
require(maps)
require(geojsonio)
require(DT)
require(plotly)
library(ggsci)
require(geofacet)
require(RColorBrewer)
require(scales)
library(imager)
library(RCurl)
library(openxlsx)
```

```{r, include=FALSE, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE, tidy=TRUE}
require(rmarkdown)
rmarkdown::render('US_all_causes_deaths_website.Rmd')
```
# Magnitude of caregiver loss and orphanhood in the United States by all causes of deaths 1999-2021

Across causes of death, there is one disproportionately affected population that tends to remain largely invisible in programming: it is the children left behind by the death of parents and caregivers responsible for their needs and nurture. The lack of support and services for such children led a recent Lancet editor to describe orphanhood as ‘a last taboo in public health’ (Health, 2022).

We here adapt previous methodologic approaches developed during the COVID-19 pandemic (S. D. Hillis, Unwin, et al., 2021), to model the incidence, prevalence, and trends from 2000-2021 in all-cause orphanhood and caregiver loss among children in the United States and by state.

We also model the distributions of top causes of orphanhood and caregiver loss among children nationally, and by age, race/ethnicity, and state, and link these estimates to an evidence-based strategy for urgently needed programming.

This assessment may allow public health decision makers to better identify children at risk among different populations and geographic areas of the country to target better prevention and protection measures.

### Orphanhood and grandparent caregiver loss defined

```{r, include=TRUE, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, tidy=TRUE,out.width="100%", fig.align='center'}
knitr::include_graphics('figures/supp_fig1_0813.jpg')
```

### Trends in All-cause Orphanhood and Caregiver Death from 2000 to 2021, before and during the pandemic


```{r, include=TRUE, out.width="100%", fig.show='hold', fig.align='center', echo=FALSE,warning=FALSE}
prevalence_1 <- read.csv('results/national_adjust_sex_v0704/National_US_incidence_summary_for_paper.csv')
prevalence_2 <- read.csv('results/national_adjust_sex_v0704/National_US_prevalence_change.csv')
prevalence = rbind(prevalence_1,prevalence_2)
colnames(prevalence) <- c('By death of', '2000', '2005', '2010', '2015', '2019', '2000-2019 change', '2020', '2021', '2019-2021 change', '2000-2021 change')
prevalence$`By death of` = c('All caregivers','Parents','Grandparent caregivers','All caregivers','Parents','Grandparent caregivers','All caregivers','Parents','Grandparent caregivers','All caregivers','Parents','Grandparent caregivers')
kbl(prevalence) %>%
  kable_paper() %>%
  add_header_above(c('', "Before the COVID-19 pandemic" = 6, "Since the COVID-19 pandemic" = 3, ''))%>%
  pack_rows("Number of children newly experiencing death of a caregiver (incidence) ", 1, 3)%>%
  pack_rows("Rate of children newly experiencing death of a caregiver per 100k children (incidence rate per 100k children) ", 4, 6)%>%
  pack_rows("Total number of children who experienced death of a caregiver in their lifetime (prevalence) ", 7, 9)%>%
  pack_rows("Total number of children who experienced death of a caregiver in their lifetime per 100k children (prevalence rate per 100k children) ", 10, 12)
```


### Magnitude of children experiencing the death of a parent in the United States

<span> (A) </span> Number of US children newly experiencing death of a parent, by any cause and over time. (B) Cumulative burden accruing from annual new cases of orphanhood. (C) Incidence rates of orphanhood among US children. (D) Prevalences rates of orphanhood among US children. (E) Main contributors to children experiencing the death of a parent versus the main contributors to adult deaths in 2021. 


```{r, include=TRUE, out.width="100%", fig.show='hold', fig.align='center', echo=FALSE,warning=FALSE}
fig1a <- readRDS("figures/figure1a.RDS") + theme(legend.position="none", axis.text = element_text(size=10), axis.title.y = element_text(size = 10))#, tooltip="text") 
fig1b <- readRDS("figures/figure1b.RDS") + theme(legend.position="none", axis.text = element_text(size=10), axis.title.y = element_text(size = 10))#, tooltip="text")
fig1c <- readRDS("figures/figure1c.RDS") + theme(legend.position="none", axis.text = element_text(size=10), axis.title.y = element_text(size = 10)) + geom_point(size=1.5) + geom_line(size =0.5)#, tooltip="text")
fig1d <- readRDS("figures/figure1d.RDS") + theme(legend.position="none", axis.text = element_text(size=10), axis.title.y = element_text(size = 10)) + geom_point(size=1.5) + geom_line(size=0.5)#, tooltip="text")
fig1e <- readRDS("figures/figure1e.RDS") + theme(axis.text = element_text(size=10), axis.title.x = element_text(size=10), strip.text=element_text(size=10), legend.text=element_text(size=8), legend.title=element_text(size=10), legend.key.size = unit(0.5,'cm'))
fig1e$layers[[5]] <- NULL
fig1e$layers[[4]] <- NULL
a = plotly_build(ggplotly(fig1e, tooltip="text"), registerFrames = FALSE)
nlists<-length(a$x$data)
for (i in 1:nlists) {
  a$x$data[[i]]$name <- gsub(',1','', a$x$data[[i]]$name)
  a$x$data[[i]]$name<- gsub("\\(|\\)",'', a$x$data[[i]]$name)
}
# fig1 <- subplot(fig1a, fig1b, fig1c, fig1d, nrows=2, margin=0.07)
#ggplotly(fig1a, tooltip="text")
combined_plot <- subplot(ggplotly(fig1a, tooltip="text"),
                         ggplotly(fig1b, tooltip="text"),
                         ggplotly(fig1c, tooltip="text") %>% layout(yaxis = list(title=list(standoff= 26L))),
                         ggplotly(fig1d, tooltip="text") %>% layout(yaxis = list(title=list(standoff= 11L))),
                         nrows = 2, titleX = TRUE, titleY = TRUE, margin = 0.07) %>% 
  layout(annotations=list(text=c('(A)', '(B)', '(C)', '(D)'), xref='paper', x=c(-0.05, 0.54, -0.05, 0.54), yref='paper', y=c(1.07, 1.07, 0.46, 0.46), showarrow=F))
combined_plot
a %>% layout(legend=list(traceorder="reversed"), textposition="top", autosize=F,
             width= 1000, height=333,
             annotations=list(text='(E)', xref='paper', yref='paper', x=-0.07, y=1.12, showarrow=F)) %>% 
  add_annotations(x=subset(fig1e$data, grepl("children", fig1e$data$variable))$value + 3,
                    y = seq(10, 1),
                    text = subset(fig1e$data, grepl("children", fig1e$data$variable))$contrib,
                    xref = "x",
                    yref = "y",
                    showarrow=FALSE,
                    font=list(size=12)) %>%
  add_annotations(x=subset(fig1e$data, grepl("contribution to deaths", fig1e$data$variable))$value - 3,
                    y = seq(10, 1),
                    text = subset(fig1e$data, grepl("contribution to deaths", fig1e$data$variable))$contrib,
                    xref = "x",
                    yref = "y",
                    showarrow=FALSE,
                    font=list(size=12))
```

### Time trends in orphanhood in the United States by age of child, race/ethnicity, and cause

<span> (A) </span> Prevalence rates of orphanhood among US children aged 0-4 years, 5-9 years and 10-17 years. (B) Prevalence rates of orphanhood among children by race and ethnicity of the deceased parent. (C) Time trends in gender and cause-specific incidence rates of orphanhood among US children. On the y-axis are shown 2021 incidence rates of orphanhood among US children, by gender and cause of death of the deceased parent. On the x-axis are shown the differences in incidence rates in 2021 minus those in 2000, with positive differences indicating increases in incidence rates and negative differences indicating decreases in incidence rates. Numbers show the cause of orphanhood. Shapes show the gender of the deceased parent. The size of points indicates the contribution of each cause to new cases of orphanhood respectively among US children in 2021.   

```{r, include=TRUE, out.width="100%", fig.show='hold', fig.align='center', echo=FALSE,warning=FALSE}
fig2a <- readRDS("figures/figure2a.RDS")
fig2b <- readRDS("figures/figure2b.RDS") #+ theme(legend.position="none", axis.text=element_text(10))
plotly2a <- ggplotly(fig2a, tooltip="text") %>% layout(yaxis=list(title=list(text="Rate of cumulative burden of<br>parental death per 100k children", standoff=10L, font=list(size=16)), tickfont=list(size=12)), xaxis=list(tickfont=list(size=12))) %>% add_annotations(x=rep(18, 3),
                    y = c(1000, 2500, 5100),
                    text = unique(fig2a$data$age.group),
                    xref = "x",
                    yref = "y",
                    showarrow=FALSE,
                    font=list(size=12))
plotly2b <- ggplotly(fig2b, tooltip="text") %>% layout(yaxis=list(title=list(text="Rate of cumulative burden of<br>parental death per 100k children", standoff=10L, font=list(size=16)), tickfont=list(size=12)), xaxis=list(tickfont=list(size=12))) %>% add_annotations(x=c(19, 16, 18, 6, 18, 20),
                    y = c(2050, 6250, 1100, 4700, 3050, 500),
                    text = unique(fig2b$data$race.eth),
                    xref = "x",
                    yref = "y",
                    showarrow=FALSE,
                    font=list(size=12))
p2d.diff =  readRDS("figures/figure2c.RDS") + theme(axis.text=element_text(size=12), #change font size of axis text
        axis.title=element_text(size=12)) #
ca = plotly_build(ggplotly(p2d.diff, tooltip="text"), registerFrames = FALSE)
nlists<-length(ca$x$data)
for (i in 1:nlists) {
  if (grepl('Mother',ca$x$data[[i]]$name)){
    ca$x$data[[i]]$showlegend <- FALSE
  }
  ca$x$data[[i]]$name <- gsub(',','', ca$x$data[[i]]$name)
  ca$x$data[[i]]$name <- gsub('Father','', ca$x$data[[i]]$name)
  ca$x$data[[i]]$name <- gsub('Mother','', ca$x$data[[i]]$name)
  ca$x$data[[i]]$name<- gsub("\\(|\\)",'', ca$x$data[[i]]$name)
  ca$x$data[[i]]$legendgroup <- ca$x$data[[i]]$name
}

ca[["x"]][["layout"]][["legend"]][["title"]][["text"]] = "Cause"
fig2c = ca
subplot(plotly2a, plotly2b, nrows=1, margin = 0.07, titleY = TRUE) %>%
  layout(annotations=list(text=c('(A)', '(B)'), xref='paper', x=c(-0.05, 0.54),
                          yref='paper', y=c(1.07, 1.07), showarrow=F))
fig2c$x$layout$annotations[[3]]$text <- "Non-Hispanic American<br>Indian or Alaska Native"
for(i in seq(from=3, to=7)){
  fig2c$x$layout$annotations[[i]]$font$size=16
}
image_file <- "figures/parent.png"
txt <- RCurl::base64Encode(readBin(image_file, "raw", file.info(image_file)[1, "size"]), "txt")

fig2c %>% layout(legend=list(orientation="h", y=-0.1, font=list(size=16),
                             title=list(font=list(size=16), side="top"),
                             visible=TRUE),
                 autosize=F, height = 1400, width = 900,
                 images = list(list(source =  paste('data:image/png;base64', txt, sep=','),
                                    xref="x domain", yref="y domain", x=2.75, y=-0.5, 
                                    xanchor="right", yanchor="top", sizex=0.5, sizey=0.5)),
                 annotations=list(text=c('(C)'), xref='paper', x=c(-0.05), yref='paper', y=c(1.07), showarrow=F))
```
<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>

### Primary contributors to orphanhood in each US state in 2021

```{r, include=TRUE, out.width="100%", fig.show='hold', fig.align='center', echo=FALSE,warning=FALSE}
orphanhood <- read.csv('results/national_adjust_sex_v0704/Table2_state_incid-prev_top2_causes_summary_for_paper.csv')

 

a = paste(orphanhood$First.ranked.cause, "(", orphanhood$Contribution.of.first.ranked.cause, ")")
orphanhood$a = a
b = paste(orphanhood$Second.ranked.cause, "(", orphanhood$Contribution.of.second.ranked.cause, ")")
orphanhood$b = b
c = paste(orphanhood$First.ranked.cause.1, "(", orphanhood$Contribution.of.first.ranked.cause.1, ")")
orphanhood$c = c
d = paste(orphanhood$Second.ranked.cause.1, "(", orphanhood$Contribution.of.second.ranked.cause.1, ")")
orphanhood$d = d

 

orphanhood <- subset(orphanhood, select = -c(First.ranked.cause,Contribution.of.first.ranked.cause,Second.ranked.cause,Contribution.of.second.ranked.cause,First.ranked.cause.1,Contribution.of.first.ranked.cause.1,Second.ranked.cause.1,Contribution.of.second.ranked.cause.1))

 

orphanhood <- orphanhood %>%
  select(State,Incidence,Incidence.rate.per.100k.children, a, b,Prevalence,Prevalence.rate.per.100k.children,c,d)

 

colnames(orphanhood)[colnames(orphanhood) == "a"] <- "First ranked cause(Contribution)"
colnames(orphanhood)[colnames(orphanhood) == "b"] <- "Second ranked cause(Contribution)"
colnames(orphanhood)[colnames(orphanhood) == "c"] <- "First ranked cause(Contribution)"
colnames(orphanhood)[colnames(orphanhood) == "d"] <- "Second ranked cause(Contribution)"

 

kbl(orphanhood) %>%
  kable_paper() %>%
  add_header_above(c('', "Children who newly experienced the loss of a parent in 2021 " = 4, "Children who experienced the loss of a parent in their lifetime in 2021" = 4)) %>%
  scroll_box(width = "100%", height = "1000px")
```

### Spatial distribution of US children experiencing parental death in 2021 {.tabset .tabset-fade}

#### Incidence

Total number of children newly experiencing parental death per 100,000 in 2021.

```{r, include=TRUE, out.width="100%", fig.show='hold', fig.align='center', echo=FALSE,warning=FALSE}
orphanhood <- data.table(read.csv('results/national_adjust_sex_v0704/Table2_state_incid-prev_top2_causes_summary_for_paper.csv'))
suppressMessages({
    spdf <- rmapshaper::ms_simplify(usa_sf(), keep = 0.1)
})

states <- 
    geojson_read( 
        x = "https://raw.githubusercontent.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.json"
        , what = "sp"
    )

us_states_centres <- read.csv("data/us_states_centres.csv")
us_states_centres$W <- - us_states_centres$W
# Change Alaska and Hawaii coordinates to match those on the map
us_states_centres$W[2] <- -112
us_states_centres$N[2] <- 27.25
us_states_centres$W[12] <- -103.8255
us_states_centres$N[12] <- 27.0451

epsg2163 <- leafletCRS(
  crsClass = "L.Proj.CRS",
  code = "EPSG:2163",
  proj4def = "+proj=laea +lat_0=45 +lon_0=-100 +x_0=0 +y_0=0 +a=6370997 +b=6370997 +units=m +no_defs",
  resolutions = 2^(16:7))

spdf <- merge(spdf,subset(orphanhood,select=c('State','Incidence.rate.per.100k.children', 'First.ranked.cause', 'Incidence', 'Contribution.of.first.ranked.cause')),by.x='name',by.y='State',all=T)
spdf <- merge(spdf,us_states_centres, by.x='name', by.y='State', all=T)
spdf <- subset(spdf,!is.na(name))

iconmap <- function(cause){
  if(cause == "Diseases of heart"){
    "figures/heart.png"
  }
  else if (cause == "Unintentional injuries"){
    "figures/unintentional_injury.png"
  }
  else if (cause == "COVID-19"){
    "figures/covid.png"
  }
  else if (cause == "Drug overdose"){
    "figures/drug.png"
  }
  else if (cause == "Malignant neoplasms"){
    "figures/neoplasm.png"
  }
  else if (cause == "Chronic liver disease and cirrhosis"){
    "figures/liver.png"
  }
  else if (cause == "Suicide"){
    "figures/suicide.png"
  }
}

icondim <- 25

causeIcons <- icons(
  iconUrl = unlist(lapply(spdf$First.ranked.cause, iconmap)),
  iconWidth=icondim, iconHeight=icondim,
  iconAnchorX=icondim/2, iconAnchorY=icondim/2
)

image_file <- "figures/heart.png"
txt.heart <- RCurl::base64Encode(readBin(image_file, "raw", file.info(image_file)[1, "size"]), "txt")
image_file <- "figures/suicide.png"
txt.suicide <- RCurl::base64Encode(readBin(image_file, "raw", file.info(image_file)[1, "size"]), "txt")
image_file <- "figures/liver.png"
txt.liver <- RCurl::base64Encode(readBin(image_file, "raw", file.info(image_file)[1, "size"]), "txt")
image_file <- "figures/covid.png"
txt.covid <- RCurl::base64Encode(readBin(image_file, "raw", file.info(image_file)[1, "size"]), "txt")
image_file <- "figures/drug.png"
txt.drug <- RCurl::base64Encode(readBin(image_file, "raw", file.info(image_file)[1, "size"]), "txt")
image_file <- "figures/neoplasm.png"
txt.neoplasm <- RCurl::base64Encode(readBin(image_file, "raw", file.info(image_file)[1, "size"]), "txt")
image_file <- "figures/unintentional_injury.png"
txt.injury <- RCurl::base64Encode(readBin(image_file, "raw", file.info(image_file)[1, "size"]), "txt")

html_legend <- paste0("<b>Leading Cause of Parental<br>Death in 2021 (# of states)</b><br>",
                      "<img src='", paste('data:image/png;base64', txt.drug, sep=','), "' width='15' height='15'> Drug overdose (32)<br/>",
                      "<img src='", paste('data:image/png;base64', txt.covid, sep=','), "' width='15' height='15'> COVID-19 (9)<br/>",
                      "<img src='", paste('data:image/png;base64', txt.injury, sep=','), "' width='15' height='15'> Unintentional Injuries (4)<br/>",
                      "<img src='", paste('data:image/png;base64', txt.heart, sep=','), "' width='15' height='15'> Diseases of Heart (3)<br/>",
                      "<img src='", paste('data:image/png;base64', txt.neoplasm, sep=','), "' width='15' height='15'> Malignant Neoplasms (2)<br/>",
                      "<img src='", paste('data:image/png;base64', txt.liver, sep=','), "' width='15' height='15'> Chronic Liver Disease<br>and Cirrhosis (1)<br/>")
                      

bins <- c(393,470,550,750,914)
pal <- colorBin("YlOrRd", domain = orphanhood$Incidence.rate.per.100k.children, bins = bins,na.color = "grey")
pal_noNA <- colorBin("YlOrRd", domain = orphanhood$Incidence.rate.per.100k.children, bins = bins, na.color = NA)

labels=paste0("<b>State :</b> ", spdf$name,
              "<br><b>Incidence rate per 100k children:</b> ", spdf$Incidence.rate.per.100k.children,
              "<br><b>Total incidence:</b> ", spdf$Incidence,
              "<br><b>Leading Cause of parental death in 2021:</b> ", spdf$First.ranked.cause,
              "<br><b>Contribution of first ranked cause:</b> ", spdf$Contribution.of.first.ranked.cause) %>%
  lapply(htmltools::HTML)


leaflet(spdf, options = leafletOptions(crs = epsg2163)) %>%
  setView(-96, 37.8, 3) %>%
  #setView(-96, 47, 3) %>%
  addProviderTiles("MapBox", options = providerTileOptions(
    id = "mapbox.light",
    accessToken = Sys.getenv('MAPBOX_ACCESS_TOKEN'))) %>%
  addPolygons(
    fillColor = ~pal(Incidence.rate.per.100k.children),
    weight = 2,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.7,
    highlight = highlightOptions(
      weight = 5,
      color = "#666",
      dashArray = "",
      fillOpacity = 0.7,
      bringToFront = TRUE),
    label = labels,
    labelOptions = labelOptions(
      style = list("font-weight" = "normal", padding = "3px 8px"),
      textsize = "15px",
      direction = "auto")) %>%
  addLegend(pal = pal_noNA, values = orphanhood$Incidence.rate.per.100k.children, opacity = 0.7, title = NULL,
    position = "topright"
  ) %>%
  addMarkers(lat=spdf$N, lng=spdf$W, icon=causeIcons) %>%
  addControl(html = html_legend, position = "bottomright")

```

#### Prevalence

Total number of children experiencing parental death per 100,000 in 2021.

```{r, include=TRUE, out.width="100%", fig.show='hold', fig.align='center', echo=FALSE,warning=FALSE} 
orphanhood <- data.table(read.csv('results/national_adjust_sex_v0704/Table2_state_incid-prev_top2_causes_summary_for_paper.csv'))
orphanhood <- transform(orphanhood, Prevalence.rate.per.100k.children = as.numeric(gsub(",", "", orphanhood$Prevalence.rate.per.100k.children)))
suppressMessages({
    spdf <- rmapshaper::ms_simplify(usa_sf(), keep = 0.1)
})

states <- 
    geojson_read( 
        x = "https://raw.githubusercontent.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.json"
        , what = "sp"
    )

us_states_centres <- read.csv("data/us_states_centres.csv")
us_states_centres$W <- - us_states_centres$W
# Change Alaska and Hawaii coordinates to match those on the map
us_states_centres$W[2] <- -112
us_states_centres$N[2] <- 27.25
us_states_centres$W[12] <- -103.8255
us_states_centres$N[12] <- 27.0451

epsg2163 <- leafletCRS(
  crsClass = "L.Proj.CRS",
  code = "EPSG:2163",
  proj4def = "+proj=laea +lat_0=45 +lon_0=-100 +x_0=0 +y_0=0 +a=6370997 +b=6370997 +units=m +no_defs",
  resolutions = 2^(16:7))

spdf <- merge(spdf,subset(orphanhood,select=c('State','Prevalence.rate.per.100k.children', 'First.ranked.cause.1', 'Prevalence', 'Contribution.of.first.ranked.cause.1')),by.x='name',by.y='State',all=T)
spdf <- merge(spdf,us_states_centres, by.x='name', by.y='State', all=T)
spdf <- subset(spdf,!is.na(name))

icondim <- 25

causeIcons <- icons(
  iconUrl = unlist(lapply(spdf$First.ranked.cause.1, iconmap)),
  iconWidth=icondim, iconHeight=icondim,
  iconAnchorX=icondim/2, iconAnchorY=icondim/2
)

html_legend <- paste0("<b>Leading Cause of Parental<br>Death in 2021 (# of states)</b><br>",
                      "<img src='", paste('data:image/png;base64', txt.drug, sep=','), "' width='15' height='15'> Drug overdose (26)<br/>",
                      "<img src='", paste('data:image/png;base64', txt.injury, sep=','), "' width='15' height='15'> Unintentional Injuries (14)<br/>",
                      "<img src='", paste('data:image/png;base64', txt.neoplasm, sep=','), "' width='15' height='15'> Malignant Neoplasms (6)<br/>",
                      "<img src='", paste('data:image/png;base64', txt.heart, sep=','), "' width='15' height='15'> Diseases of Heart (4)<br/>",
                      "<img src='", paste('data:image/png;base64', txt.suicide, sep=','), "' width='15' height='15'> Suicide (1)<br/>")
                      

bins <- c(2339,2500,3000,4000,5261)
pal <- colorBin("YlOrRd", domain = orphanhood$Prevalence.rate.per.100k.children, bins = bins,na.color = "grey")
pal_noNA <- colorBin("YlOrRd", domain = orphanhood$Prevalence.rate.per.100k.children, bins = bins, na.color = NA)

labels=paste0("<b>State :</b> ", spdf$name,
              "<br><b>Prevalence rate per 100k children:</b> ", formatC(spdf$Prevalence.rate.per.100k.children, digits=0, format="f", big.mark=","),
              "<br><b>Total prevalence:</b> ", spdf$Prevalence,
              "<br><b>Leading Cause of parental death in 2021:</b> ", spdf$First.ranked.cause.1,
              "<br><b>Contribution of first ranked cause:</b> ", spdf$Contribution.of.first.ranked.cause.1) %>%
  lapply(htmltools::HTML)

leaflet(spdf, options = leafletOptions(crs = epsg2163)) %>%
  setView(-96, 37.8, 3) %>%
  #setView(-96, 47, 3) %>%
  addProviderTiles("MapBox", options = providerTileOptions(
    id = "mapbox.light",
    accessToken = Sys.getenv('MAPBOX_ACCESS_TOKEN'))) %>%
  addPolygons(
    fillColor = ~pal(Prevalence.rate.per.100k.children),
    weight = 2,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.7,
    highlight = highlightOptions(
      weight = 5,
      color = "#666",
      dashArray = "",
      fillOpacity = 0.7,
      bringToFront = TRUE),
    label = labels,
    labelOptions = labelOptions(
      style = list("font-weight" = "normal", padding = "3px 8px"),
      textsize = "15px",
      direction = "auto")) %>%
  addLegend(pal = pal_noNA, values = orphanhood$Prevalence.rate.per.100k.children, opacity = 0.7, title = NULL,
    position = "topright"
  ) %>%
  addMarkers(lat=spdf$N, lng=spdf$W, icon=causeIcons) %>%
  addControl(html = html_legend, position = "bottomright")

```
#


<span> (A) </span> Number of children newly experiencing death of a parent, by state and cause. (B) Cumulative burden of children newly experiencing death of a parent, accrueing new cases over the past 18 years. (C) Incidence rates of children newly experiencing death of a parent, by state and cause. The vertical dashed line indicates the average incidence rate across states, weighted by population size. (D) Prevalence rates of children newly experiencing death of a parent, by state and cause. The vertical dashed line indicates the average prevalence rate across states, weighted by population size.

```{r, include=TRUE, out.width="100%", fig.show='hold', fig.align='center', echo=FALSE,warning=FALSE}
fig3plots <- readRDS('figures/figure3.RDS')
p3 <- ggplotly(fig3plots$p3, tooltip="text") %>% layout(yaxis=list(tickfont=list(size=8)))
p3[["x"]][["layout"]][["xaxis"]][["title"]][["text"]] = "Number of children newly experiencing<br>parental death in 2021"
subplot(p3, ggplotly(fig3plots$p1, tooltip="text") %>% layout(yaxis=list(tickfont=list(size=8))), margin=0.1, titleX=T) %>%
  layout(annotations=list(text=c('(A)', '(B)'), xref='paper', x=c(-0.04, 0.58),
                          yref='paper', y=c(1.06, 1.06), showarrow=F))
p4 <- ggplotly(fig3plots$p4, tooltip="text") %>% layout(yaxis=list(tickfont=list(size=8)))
p4[["x"]][["layout"]][["xaxis"]][["title"]][["text"]] = "Rate of children newly experiencing parental<br>death per 100,000 children in 2021"
p2 <- ggplotly(fig3plots$p2, tooltip="text") %>% layout(yaxis=list(tickfont=list(size=8)))
p2[["x"]][["layout"]][["xaxis"]][["title"]][["text"]] <- "Rate of all children currently experiencing<br>parental death per 100,000 children in 2021"
subplot(p4, p2, margin=0.1, titleX=T) %>%
  layout(annotations=list(text=c('(C)', '(D)'), xref='paper', x=c(-0.04, 0.58),
                          yref='paper', y=c(1.06, 1.06), showarrow=F))
```

### Further information

This is an official product of the Global Reference Group for Children Affected by COVID-19 (with members from Imperial College London, WHO, World Bank, CDC, USAID, University of Oxford, University College London, Harvard University, Maestral International, and World Without Orphans); the WHO Collaborating Centre for Infectious Disease Modelling within the MRC Centre for Global Infectious Disease Analysis, Jameel Institute, Imperial College London; and the Department of Social Policy and Intervention and the Department of Computer Science, University of Oxford.

This website has been built and reviewed by Linden Graves, Douhan Wang, Victor Kojey-Merle, Yu Chen, Alexandra Blenkinsop and Oliver Ratmann.

